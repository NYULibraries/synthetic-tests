version: "3.7"

x-serverless-build: &serverless-build
  build:
    context: .
    dockerfile: Dockerfile.node
  image: synthetic-tests-node

x-e2e-build: &e2e-build
  build:
    context: .
    dockerfile: Dockerfile
  image: synthetic-tests-e2e

x-default-volumes: &default-volumes
  volumes:
    - ./lib:/var/task/lib
    - ./spec:/var/task/spec
    - ./handler.js:/var/task/handler.js
    - ./package.json:/var/task/package.json
    - ./yarn.lock:/var/task/yarn.lock
    - ./serverless.yml:/var/task/serverless.yml
    - ./jest.config.js:/var/task/jest.config.js

x-test_env: &test-env
  environment:
    TEST_URL: "https://bobcat.library.nyu.edu/this/is/a/test/please/ignore"
    EXPECTED_CODE: 502
    EXPECTED_RESPONSE_TIME_MS: 400
    SLACK_URL:

x-serverless_env: &serverless-env
  environment:
    AWS_ACCESS_KEY_ID:
    AWS_SECRET_ACCESS_KEY:
    S3_BUCKET:
    LAMBDA_ROLE:
    SERVERLESS_STAGE:
    AWS_REGION:
    SLACK_URL:
  env_file:
    - .env

services:
  dev:
    build:
      context: .
      dockerfile: Dockerfile.lambda
    image: synthetic-tests-lambda
    command: ["handler.syntheticTest"]
    <<: *test-env
    volumes:
      - node_modules:/var/task/node_modules
    depends_on:
      - npm_install

  npm_install:
    <<: *serverless-build
    volumes:
      - node_modules:/var/task/node_modules

  test:
    <<: *serverless-build
    command: ["yarn", "test"]
    <<: *test-env
    #<<: *default-volumes

  e2e:
    <<: *e2e-build
    command: ["yarn", "nightwatch"]

  deploy:
    <<: *serverless-build
    <<: *serverless-env
    <<: *default-volumes

  invoke:
    <<: *serverless-build
    entrypoint: ["serverless", "invoke", "-f"]
    <<: *serverless-env
    <<: *default-volumes

volumes:
  node_modules:
